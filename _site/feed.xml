<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en"><generator uri="https://jekyllrb.com/" version="3.9.2">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" hreflang="en" /><updated>2022-11-15T10:22:34+08:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Chen Huang’ Blog</title><subtitle>A technical blog for writing and note-taking.</subtitle><author><name>Chen Huang</name></author><entry><title type="html">使用SSH双向同步文件的方法</title><link href="http://localhost:4000/2022/11/14/%E4%BD%BF%E7%94%A8SSH%E5%8F%8C%E5%90%91%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html" rel="alternate" type="text/html" title="使用SSH双向同步文件的方法" /><published>2022-11-14T00:00:00+08:00</published><updated>2022-11-14T00:00:00+08:00</updated><id>http://localhost:4000/2022/11/14/%E4%BD%BF%E7%94%A8SSH%E5%8F%8C%E5%90%91%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95</id><content type="html" xml:base="http://localhost:4000/2022/11/14/%E4%BD%BF%E7%94%A8SSH%E5%8F%8C%E5%90%91%E5%90%8C%E6%AD%A5%E6%96%87%E4%BB%B6%E7%9A%84%E6%96%B9%E6%B3%95.html"><![CDATA[<p>由于目前坚果云对LEEEP服务器端的支持有限，在此介绍基于SSH服务的文件双向同步模式，可以使指定PC与服务器端的双向同步。</p>

<!--more-->

<h3 id="服务端软件">服务端软件：</h3>
<ul>
  <li>OpenSSH：提供SSH接口服务（已提前配置）</li>
  <li>Powershell：用于设置SSHkey和测试链接</li>
</ul>

<h3 id="pc端软件">PC端软件：</h3>
<ul>
  <li>Powershell：用于设置SSHkey和测试链接</li>
  <li>WinScp：用于实现PC端与服务端的文件夹对应和同步监控</li>
</ul>

<hr />
<h2 id="sshkey配置">SSHkey配置</h2>
<h3 id="步骤一服务器端openssh服务配置-已配置完毕">步骤一：服务器端OpenSSH服务配置 (已配置完毕)</h3>
<p>通过与马腾、吴雅珍、肖逸龙三位同学的沟通，黄晨已在TEC、CGE和线上模型三台服务器上配置好OpenSSH初始服务。此处不再赘述，相关配置教程可以参照：<a href="https://www.hostwinds.com/tutorials/how-to-install-and-configure-openssh-windows-server-2016">How to Install and Configure OpenSSH</a>和<a href="https://blog.csdn.net/RobinZZX/article/details/124070198?spm=1001.2101.3001.6650.1&amp;depth_1-utm_relevant_index=2">Windows之间使用OpenSSH的ssh免密登录</a>两份参考资料。</p>

<h3 id="步骤二pc端生成sshkey">步骤二：PC端生成sshkey</h3>
<ul>
  <li>Win+Q搜索Windows PowerShell，运行
    <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh-keygen -t rsa
</code></pre></div>    </div>
    <p>若出现提示，可多次回车选择默认选项。此时将在“C:\Users\Administrator.ssh”文件夹下生成两个文件”id_rsa”和”id_rsa.pub”，前者为私钥，后者为公钥。</p>
  </li>
</ul>

<h3 id="步骤三公钥授权">步骤三：公钥授权</h3>
<p>在服务端打开PowerShell（若是管理员身份，则以管理员身份运行），进入用户文件夹（管理员：”C:\Users\Administrator”；非管理员：”C:\Users\指定用户名”），输入如下命令：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir .ssh # 新建.ssh文件夹（若存在则忽略）
cd .ssh # 进入.ssh文件夹
New-Item authorized_keys # 创建authorized_keys文件，若存在则忽略
</code></pre></div></div>
<p>将PC端的id_rsa.pub文件内容粘贴到服务端authorized_keys文件中。（注：如果已存在其他用户的公钥内容，注意换行添加即可，勿删除此前内容）</p>

<hr />

<h2 id="连接">连接</h2>
<h3 id="连接测试">连接测试</h3>
<p>在PC端PowerShell软件中输入</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ssh -p 2233 用户名@IP地址 # 此时无需密码直接登录说明正常，首次登陆会提示是否加入know_hosts，输入yes即可
</code></pre></div></div>
<p>注：此处端口号填写2233（OpenSSH配置端口，黄晨设置）</p>

<h3 id="正式连接">正式连接</h3>
<ol>
  <li>下载、安装、打开WinSCP软件</li>
  <li>新建链接
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131400877.png" alt="" />
    <ul>
      <li>进入Advanced-Authentication-Private key file，选择此前生成id_rsa文件的文件夹
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131400225.png" alt="" /></li>
    </ul>
  </li>
</ol>

<p><img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131403855.png" alt="" /></p>
<ul>
  <li>打开id_rsa后会弹出下面界面，依次选择OK-保存-OK-OK
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131403131.png" alt="" /></li>
  <li>点击Login（可以选择Save来保存这一配置，免得下次重新配置）
连接成功后会右侧出现远程服务器的文件夹，即连接成功。
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131406489.png" alt="" /></li>
</ul>

<hr />

<h2 id="同步示例">同步示例</h2>
<h3 id="单向同步常用">单向同步（常用）</h3>
<p>此处利用PC端的SSHtest和服务端的SSHtest文件夹演示
点选如下服务端同步模块，并依次设置
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131416905.png" alt="" /></p>

<p><img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131420736.png" alt="" />
<strong>注意：服务端的路径起始处有”/”</strong></p>

<p><img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131418554.png" alt="" /></p>

<ul>
  <li>如此，单向同步设置完毕，PC端出现文件变动，都会同步更新到服务端。由此便可实现一个本地<strong>坚果云类似服务</strong>。
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131430614.png" alt="" /></li>
</ul>

<h3 id="双向同步不常用">双向同步（不常用）</h3>
<ul>
  <li>利用Synchronize模块实现双向同步
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131410388.png" alt="" /></li>
  <li>利用PC端的SSHtest和服务端的SSHtest文件夹演示
此处选择了双向同步并预览变动，选择OK。实际使用时可按自身需求选择单向或双向同步。
<img src="https://chen-1300607714.cos.ap-shanghai.myqcloud.com/%E5%9B%BE%E5%BA%8A/202211131412986.png" alt="" /></li>
</ul>

<hr />

<h2 id="总结">总结</h2>
<p>本文是针对SSH服务的SFTP软件应用，以达成类似的坚果云自动同步效果，避免人为手动同步带来的时间成本和潜在失误。
其实除了WinSCP软件，还有很多支持SFTP的软件。例如，利用VS Code及其STFP插件也可以实现类似功能。但由于LEEEP服务器是Windows版本，VS Code需要的相关权限高于WinSCP，需要许多额外的配置。而WinSCP的功能已基本满足工作需求，因此本文不再阐述其他软件的应用方法，针对VS Code在Windows服务器端的远程权限问题，可见该<a href="https://github.com/microsoft/vscode-remote-release/issues/2648">Github ISSUE</a> 。</p>]]></content><author><name>Chen Huang</name></author><category term="SSH" /><category term="SFTP" /><summary type="html"><![CDATA[由于目前坚果云对LEEEP服务器端的支持有限，在此介绍基于SSH服务的文件双向同步模式，可以使指定PC与服务器端的双向同步。]]></summary></entry><entry><title type="html">xarray学习笔记</title><link href="http://localhost:4000/python/2021/02/21/xarray%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html" rel="alternate" type="text/html" title="xarray学习笔记" /><published>2021-02-21T00:00:00+08:00</published><updated>2021-02-21T00:00:00+08:00</updated><id>http://localhost:4000/python/2021/02/21/xarray%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0</id><content type="html" xml:base="http://localhost:4000/python/2021/02/21/xarray%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html"><![CDATA[<p>本文介绍了xarray软件的基本使用方法。</p>

<!--more-->

<p>类似软件<a href="https://scitools-iris.readthedocs.io/en/latest/index.html">Iris</a></p>
<h3 id="xarray-n-d-labeled-arrays-and-datasets-in-python">xarray: N-D labeled arrays and datasets in Python</h3>

<p><strong>xarray</strong> (formerly <strong>xray</strong>) is an open source project and Python package that makes working with labelled multi-dimensional arrays simple, efficient, and fun!</p>

<p>Xarray introduces labels in the form of <strong>dimensions, coordinates and attributes（维度、坐标和属性）</strong> on top of raw <a href="http://www.numpy.org/">NumPy</a>-like arrays, which allows for a more intuitive, more concise, and less error-prone developer experience. The package includes a large and growing library of domain-agnostic functions for advanced analytics and visualization with these data structures.</p>

<p>Xarray is inspired by and borrows heavily from <a href="http://pandas.pydata.org/">pandas</a>, the popular data analysis package focused on labelled tabular data. It is particularly tailored to working with <a href="http://www.unidata.ucar.edu/software/netcdf">netCDF</a> files, which were the source of xarray’s data model, and integrates tightly with <a href="http://dask.org/">dask</a> for parallel computing.</p>

<h2 id="why-xarray">Why xarray?</h2>
<h3 id="what-labels-enable">What labels enable</h3>
<p>Multi-dimensional (a.k.a. N-dimensional, ND) arrays (sometimes called <strong>“tensors”（张量）</strong>) are an essential part of computational science. They are encountered in a wide range of fields, including physics, astronomy, geoscience, bioinformatics, engineering, finance, and deep learning. In Python, <a href="https://www.numpy.org/">NumPy</a> provides the fundamental data structure and API for working with raw ND arrays. <strong>However, real-world datasets are usually more than just raw numbers; they have labels which encode information about how the array values map to locations in space, time, etc.</strong></p>

<p>Xarray doesn’t just keep track of labels on arrays – it uses them to provide a powerful and concise interface. For example:</p>

<ul>
  <li>Apply operations over dimensions by name: <code class="language-plaintext highlighter-rouge">x.sum('time')</code>.</li>
  <li>Select values by label instead of integer location: <code class="language-plaintext highlighter-rouge">x.loc['2014-01-01']</code> or <code class="language-plaintext highlighter-rouge">x.sel(time='2014-01-01')</code>.</li>
  <li>Mathematical operations (e.g., <code class="language-plaintext highlighter-rouge">x - y</code>) vectorize across multiple dimensions (array broadcasting) based on dimension names, not shape.</li>
  <li>Flexible split-apply-combine operations with groupby: <code class="language-plaintext highlighter-rouge">x.groupby('time.dayofyear').mean()</code>.</li>
  <li>Database like alignment based on coordinate labels that smoothly handles missing values: <code class="language-plaintext highlighter-rouge">x, y = xr.align(x, y, join='outer')</code>.</li>
  <li>Keep track of arbitrary metadata in the form of a Python dictionary: <code class="language-plaintext highlighter-rouge">x.attrs</code>.</li>
</ul>

<p>The N-dimensional nature of xarray’s data structures makes it suitable for dealing with multi-dimensional scientific data, and its use of dimension names instead of axis labels (<code class="language-plaintext highlighter-rouge">dim='time'</code> instead of <code class="language-plaintext highlighter-rouge">axis=0</code>) makes such arrays much more manageable than the raw numpy ndarray: with xarray, you don’t need to keep track of the order of an array’s dimensions or insert dummy dimensions of size 1 to align arrays (e.g., using <code class="language-plaintext highlighter-rouge">np.newaxis</code>).</p>

<h3 id="core-data-structures">Core data structures</h3>
<p><a href="http://xarray.pydata.org/en/stable/generated/xarray.DataArray.html#xarray.DataArray" title="xarray.DataArray"><code class="language-plaintext highlighter-rouge">DataArray</code></a> is our implementation of a labeled, N-dimensional array. It is an N-D generalization of a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.Series</code></a>. The name <code class="language-plaintext highlighter-rouge">DataArray</code> itself is borrowed from Fernando Perez’s <a href="https://github.com/fperez/datarray">datarray</a> project, which prototyped a similar data structure.</p>

<p><a href="http://xarray.pydata.org/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="xarray.Dataset"><code class="language-plaintext highlighter-rouge">Dataset</code></a> is a multi-dimensional, in-memory array database. It is a dict-like container of <code class="language-plaintext highlighter-rouge">DataArray</code> objects aligned along any number of shared dimensions, and serves a similar purpose in xarray to the <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.DataFrame</code></a>.</p>

<h2 id="quick-overview">Quick overview</h2>
<h3 id="create-dataarray">Create DataArray</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="n">xr</span>
<span class="n">data</span><span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span><span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">),</span><span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s">'x'</span><span class="p">:[</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">]})</span>
<span class="n">data</span><span class="p">.</span><span class="n">values</span>
<span class="n">data</span><span class="p">.</span><span class="n">dims</span>
<span class="n">data</span><span class="p">.</span><span class="n">coords</span>
<span class="n">data</span><span class="p">.</span><span class="n">attrs</span>
</code></pre></div></div>
<h3 id="indexing">Indexing</h3>
<p>xarray supports four kinds of indexing.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span>
<span class="n">data</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span>
<span class="n">data</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</code></pre></div></div>
<p>Unlike positional indexing, label-based indexing frees us from having to know how our array is organized. All we need to know are the dimension name and the label we wish to index i.e. <code class="language-plaintext highlighter-rouge">data.sel(x=10)</code> works regardless of whether <code class="language-plaintext highlighter-rouge">x</code> is the first or second dimension of the array and regardless of whether <code class="language-plaintext highlighter-rouge">10</code> is the first or second element of <code class="language-plaintext highlighter-rouge">x</code>. We have already told xarray that x is the first dimension when we created <code class="language-plaintext highlighter-rouge">data</code>: xarray keeps track of this so we don’t have to.</p>

<h3 id="attributes">Attributes</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">"long_name"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"random velocity"</span>

<span class="n">data</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">"units"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"metres/sec"</span>

<span class="n">data</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">"description"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"A random variable created as an example."</span>

<span class="n">data</span><span class="p">.</span><span class="n">attrs</span><span class="p">[</span><span class="s">"random_attribute"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123</span>
<span class="n">data</span><span class="p">.</span><span class="n">attrs</span>
</code></pre></div></div>
<p><code class="language-plaintext highlighter-rouge">attrs</code> is just a Python dictionary, so you can assign anything you wish.</p>

<h3 id="computation">Computation</h3>
<p>Data arrays work very similarly to numpy ndarrays:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="o">+</span><span class="mi">10</span>
<span class="n">np</span><span class="p">.</span><span class="n">sin</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="n">T</span>
<span class="n">data</span><span class="p">.</span><span class="nb">sum</span><span class="p">()</span>
</code></pre></div></div>
<p>However, aggregation operations can use dimension names instead of axis numbers:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s">'x'</span><span class="p">)</span> <span class="c1">#x是维度之一
</span></code></pre></div></div>
<p>Arithmetic operations broadcast based on <strong>dimension name</strong>. This means you don’t need to insert dummy dimensions for alignment:</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">3</span><span class="p">),[</span><span class="n">data</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">'y'</span><span class="p">]])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">randn</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">dims</span><span class="o">=</span><span class="s">'z'</span><span class="p">)</span>
<span class="n">a</span><span class="o">+</span><span class="n">b</span>
<span class="o">&lt;</span><span class="n">xarray</span><span class="p">.</span><span class="n">DataArray</span> <span class="p">(</span><span class="n">y</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="n">z</span><span class="p">:</span> <span class="mi">4</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">array</span><span class="p">(</span>\<span class="p">[</span>\<span class="p">[</span><span class="o">-</span><span class="mf">0.63456326</span><span class="p">,</span>  <span class="mf">0.03405836</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.75318703</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.93960659</span>\<span class="p">],</span>
 \<span class="p">[</span><span class="o">-</span><span class="mf">0.4622225</span> <span class="p">,</span>  <span class="mf">0.20639913</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.58084626</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.76726583</span>\<span class="p">],</span>
 \<span class="p">[</span><span class="o">-</span><span class="mf">2.7542705</span> <span class="p">,</span> <span class="o">-</span><span class="mf">2.08564887</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.87289427</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.05931383</span>\<span class="p">]</span>\<span class="p">])</span>
<span class="n">Coordinates</span><span class="p">:</span>
 \<span class="o">*</span> <span class="n">y</span>        <span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="n">int64</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span>
<span class="n">Dimensions</span> <span class="n">without</span> <span class="n">coordinates</span><span class="p">:</span> <span class="n">z</span>
</code></pre></div></div>
<p>甚至大多数情况下可以不考虑维度的形状</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">-</span> <span class="n">data</span><span class="p">.</span><span class="n">T</span>
</code></pre></div></div>

<h3 id="groupby">Groupby</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">labels</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([</span><span class="s">'E'</span><span class="p">,</span><span class="s">'F'</span><span class="p">,</span><span class="s">'E'</span><span class="p">],[</span><span class="n">data</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">'y'</span><span class="p">]],</span><span class="n">name</span><span class="o">=</span><span class="s">'labels'</span><span class="p">)</span>
<span class="n">data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="s">'y'</span><span class="p">)</span> <span class="c1">#以EF为归类方式，列间（y列维度）取平均
</span><span class="n">data</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">labels</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="s">'x'</span><span class="p">)</span> <span class="c1">#以EF为归类方式，行间（x行维度）取平均 
</span></code></pre></div></div>
<h3 id="plotting">Plotting</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span><span class="p">.</span><span class="n">plot</span><span class="p">()</span>
</code></pre></div></div>
<h3 id="pandas">pandas</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">series</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">to_series</span><span class="p">()</span>
<span class="n">series</span>
<span class="n">series</span><span class="p">.</span><span class="n">to_xarray</span><span class="p">()</span>
</code></pre></div></div>
<h3 id="datasets">Datasets</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s">'foo'</span><span class="p">:</span><span class="n">data</span><span class="p">,</span><span class="s">'bar'</span><span class="p">:(</span><span class="s">'x'</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]),</span><span class="s">'barz'</span><span class="p">:</span><span class="n">np</span><span class="p">.</span><span class="n">pi</span><span class="p">})</span>
<span class="n">ds</span> <span class="c1">#一个包含三个DataArray的Dataset
</span><span class="n">ds</span><span class="p">.</span><span class="n">foo</span> <span class="c1">#两种提取维度/坐标数据的方式
</span><span class="n">ds</span><span class="p">[</span><span class="s">'foo'</span><span class="p">]</span>
</code></pre></div></div>
<p>Variables in datasets can have different <code class="language-plaintext highlighter-rouge">dtype</code> and even different dimensions, but all dimensions are assumed to refer to points in the same shared coordinate system i.e. if two variables have dimension <code class="language-plaintext highlighter-rouge">x</code>, that dimension must be identical in both variables.
foo和bar都含有x这一个坐标系，二者的这一坐标系必须一致</p>
<h3 id="read-write-netcdf-files">Read&amp; write netCDF files</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="s">'example.nc'</span><span class="p">)</span>
<span class="n">xr</span><span class="p">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="s">'example.nc'</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="terminology">Terminology</h2>
<h3 id="dataarray">DataArray</h3>
<p>A multi-dimensional array with labeled or named dimensions. <code class="language-plaintext highlighter-rouge">DataArray</code> objects add metadata such as dimension names, coordinates, and attributes (defined below) to underlying “unlabeled” data structures such as numpy and Dask arrays. If its optional <code class="language-plaintext highlighter-rouge">name</code> property is set, it is a <em>named DataArray</em>.</p>
<h3 id="dataset">Dataset</h3>
<p>A dict-like collection of <code class="language-plaintext highlighter-rouge">DataArray</code> objects with aligned dimensions. Thus, most operations that can be performed on the dimensions of a single <code class="language-plaintext highlighter-rouge">DataArray</code> can be performed on a dataset. Datasets have data variables (see <strong>Variable</strong> below), dimensions, coordinates, and attributes.</p>
<h3 id="variable">Variable</h3>
<p>A <a href="https://www.unidata.ucar.edu/software/netcdf/docs/netcdf_data_set_components.html#variables">NetCDF-like variable</a> consisting of dimensions, data, and attributes which describe a single array. The main functional difference between variables and numpy arrays is that numerical operations on variables implement array broadcasting by dimension name. Each <code class="language-plaintext highlighter-rouge">DataArray</code> has an underlying variable that can be accessed via <code class="language-plaintext highlighter-rouge">arr.variable</code>. However, a variable is not fully described outside of either a <code class="language-plaintext highlighter-rouge">Dataset</code> or a <code class="language-plaintext highlighter-rouge">DataArray</code>.</p>
<h3 id="dimension">Dimension</h3>
<p>In mathematics, the <em>dimension</em> of data is loosely the number of degrees of freedom for it. A <em>dimension axis</em> is a set of all points in which all but one of these degrees of freedom is fixed. We can think of each dimension axis as having a name, for example the “x dimension”. In xarray, a <code class="language-plaintext highlighter-rouge">DataArray</code> object’s <em>dimensions</em> are its named dimension axes, and the name of the <code class="language-plaintext highlighter-rouge">i</code>-th dimension is <code class="language-plaintext highlighter-rouge">arr.dims[i]</code>. If an array is created without dimension names, the default dimension names are <code class="language-plaintext highlighter-rouge">dim_0</code>, <code class="language-plaintext highlighter-rouge">dim_1</code>, and so forth.
维度、自由度</p>
<h3 id="coordinate">Coordinate</h3>
<p>An array that labels a dimension or set of dimensions of another <code class="language-plaintext highlighter-rouge">DataArray</code>. In the usual one-dimensional case, the coordinate array’s values can loosely be thought of as tick labels along a dimension. There are two types of coordinate arrays: <em>dimension coordinates</em> and <em>non-dimension coordinates</em> (see below). A coordinate named <code class="language-plaintext highlighter-rouge">x</code> can be retrieved from <code class="language-plaintext highlighter-rouge">arr.coords[x]</code>. A <code class="language-plaintext highlighter-rouge">DataArray</code> can have more coordinates than dimensions because a single dimension can be labeled by multiple coordinate arrays. However, only one coordinate array can be a assigned as a particular dimension’s dimension coordinate array. As a consequence, <code class="language-plaintext highlighter-rouge">len(arr.dims) &lt;= len(arr.coords)</code> in general.</p>

<h3 id="dimension-coordinate">Dimension coordinate</h3>
<p>A one-dimensional coordinate array assigned to <code class="language-plaintext highlighter-rouge">arr</code> with both a name and dimension name in <code class="language-plaintext highlighter-rouge">arr.dims</code>. Dimension coordinates are used for label-based indexing and alignment, like the index found on a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.DataFrame</code></a> or <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.Series</code></a>. In fact, dimension coordinates use <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Index.html#pandas.Index" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.Index</code></a> objects under the hood for efficient computation. Dimension coordinates are marked by <code class="language-plaintext highlighter-rouge">*</code> when printing a <code class="language-plaintext highlighter-rouge">DataArray</code> or <code class="language-plaintext highlighter-rouge">Dataset</code>.
与pandas.Index类似</p>

<h4 id="non-dimension-coordinate">Non-dimension coordinate</h4>
<p>A coordinate array assigned to <code class="language-plaintext highlighter-rouge">arr</code> with a name in <code class="language-plaintext highlighter-rouge">arr.coords</code> but <em>not</em> in <code class="language-plaintext highlighter-rouge">arr.dims</code>. These coordinates arrays can be one-dimensional or multidimensional, and they are useful for auxiliary labeling. As an example, multidimensional coordinates are often used in geoscience datasets when <a href="http://xarray.pydata.org/en/stable/examples/multidimensional-coords.html">the data’s physical coordinates (such as latitude and longitude) differ from their logical coordinates</a>. However, non-dimension coordinates are not indexed, and any operation on non-dimension coordinates that leverages indexing will fail. Printing <code class="language-plaintext highlighter-rouge">arr.coords</code> will print all of <code class="language-plaintext highlighter-rouge">arr</code>’s coordinate names, with the corresponding dimension(s) in parentheses. For example, <code class="language-plaintext highlighter-rouge">coord_name (dim_name) 1 2 3 ...</code>.</p>
<h3 id="index">Index</h3>
<p>An <em>index</em> is a data structure optimized for efficient selecting and slicing of an associated array. Xarray creates indexes for dimension coordinates so that operations along dimensions are fast, while non-dimension coordinates are not indexed. Under the hood, indexes are implemented as <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Index.html#pandas.Index" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">pandas.Index</code></a> objects. The index associated with dimension name <code class="language-plaintext highlighter-rouge">x</code> can be retrieved by <code class="language-plaintext highlighter-rouge">arr.indexes[x]</code>. By construction, <code class="language-plaintext highlighter-rouge">len(arr.dims) == len(arr.indexes)</code></p>

<h3 id="name">name</h3>
<p>The names of dimensions, coordinates, DataArray objects and data variables can be anything as long as they are <a href="https://docs.python.org/3/glossary.html#term-hashable" title="(in Python v3.9)">hashable</a>. However, it is preferred to use <a href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">str</code></a> typed names.
任意，只要hashable</p>
<h3 id="scalar">scalar</h3>
<p>By definition, a scalar is not an <a href="https://numpy.org/doc/stable/glossary.html#term-array" title="(in NumPy v1.19)">array</a> and when converted to one, it has 0 dimensions. That means that, e.g., <a href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">int</code></a>, <a href="https://docs.python.org/3/library/functions.html#float" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">float</code></a>, and <a href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">str</code></a> objects are “scalar” while <a href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">list</code></a> or <a href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">tuple</code></a> are not.</p>
<h3 id="duck-array">duck array</h3>
<p><a href="https://numpy.org/neps/nep-0022-ndarray-duck-typing-overview.html">Duck arrays</a> are array implementations that behave like numpy arrays. They have to define the <code class="language-plaintext highlighter-rouge">shape</code>, <code class="language-plaintext highlighter-rouge">dtype</code> and <code class="language-plaintext highlighter-rouge">ndim</code> properties. For integration with <code class="language-plaintext highlighter-rouge">xarray</code>, the <code class="language-plaintext highlighter-rouge">__array__</code>, <code class="language-plaintext highlighter-rouge">__array_ufunc__</code> and <code class="language-plaintext highlighter-rouge">__array_function__</code> protocols are also required.</p>
<h2 id="data-structures">Data structures</h2>
<h3 id="dataarray-1">DataArray</h3>
<h4 id="核心要素properties">核心要素properties</h4>
<ul>
  <li>values: a multi-dimensional array of values (e.g., a numpy ndarray, <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.Series.html#pandas.Series" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">Series</code></a>, <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">DataFrame</code></a> or <code class="language-plaintext highlighter-rouge">pandas.Panel</code>)</li>
  <li>dims: a list of dimension names. If omitted and <code class="language-plaintext highlighter-rouge">coords</code> is a list of tuples, dimension names are taken from <code class="language-plaintext highlighter-rouge">coords</code>.</li>
  <li>coords: a list or dictionary of coordinates. If a list, it should be a list of tuples where the first element is the dimension name and the second element is the corresponding coordinate array_like object.</li>
  <li>attrs: a dictionary of attributes to add to the instance</li>
  <li>name: a string that names the instance
    <h4 id="创建dataarray">创建DataArray</h4>
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">locs</span> <span class="o">=</span> <span class="p">[</span><span class="s">'IA'</span><span class="p">,</span><span class="s">'IL'</span><span class="p">,</span><span class="s">'IN'</span><span class="p">]</span>
<span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">data_range</span><span class="p">(</span><span class="s">'2000-01-01'</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">foo</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">coords</span> <span class="o">=</span> <span class="p">[</span><span class="n">times</span><span class="p">,</span><span class="n">locs</span><span class="p">],</span> <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s">'time'</span><span class="p">,</span> <span class="n">space</span><span class="p">])</span>
<span class="n">foo</span>
</code></pre></div>    </div>
    <p>dimension names are always present in the xarray data model: if you do not provide them, defaults of the form <code class="language-plaintext highlighter-rouge">dim_N</code> will be created. However, coordinates are always optional, and dimensions do not have automatic coordinate labels.
If you supply <code class="language-plaintext highlighter-rouge">coords</code> as a dictionary, you must explicitly provide <code class="language-plaintext highlighter-rouge">dims</code>.
```python
列表形式
xr.DataArray(data, coords = [(‘time’,times),(‘space’,locs)])</p>
  </li>
</ul>

<p>字典形式
xr.DataArray(
	data,
	coords = {
	‘time’:times,
	‘space’:locs,
	‘const’:42,
	‘ranking’:(‘space’,[1,2,3]),
	},
	dims=[‘time’,’space’]
)
一个坐标覆盖两个维度
xr.DataArray(
	data,
	coords = {
	‘time’:times,
	‘space’:locs,
	‘const’:42,
	‘ranking’:((‘time’,’space’),np.arange(12).reshape(4,3)),
	},
	dims=[‘time’,’space’]
)
从pandas.DataFrame导入
df = pd.DataFrame({‘x’:[0,1],’y’:[2,3]},index = [‘a’,’b’])
df.index.name = ‘abc’
df.columns.name = ‘xyz’
df
xr.DataArray(df)</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>**DataArray的values只支持同类型数据**
#### DataArray的要素
	values
	dims
	coords
	attrs
#### 获取DataArray的坐标Coordinates
两种方式
```python
foo.coords['time']
foo['time']
</code></pre></div></div>
<p>新增和删除coords</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">foo</span><span class="p">[</span><span class="s">'ranking'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">'space'</span><span class="p">,[</span><span class="mi">1</span><span class="p">,</span><span class="mi">23</span><span class="p">])</span>
<span class="k">del</span> <span class="n">foo</span><span class="p">[</span><span class="s">'ranking'</span><span class="p">]</span>
</code></pre></div></div>
<h3 id="dataset-1">Dataset</h3>
<p><a href="http://xarray.pydata.org/en/stable/generated/xarray.Dataset.html#xarray.Dataset" title="xarray.Dataset"><code class="language-plaintext highlighter-rouge">xarray.Dataset</code></a> is xarray’s multi-dimensional equivalent of a <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">DataFrame</code></a>. It is a dict-like container of labeled arrays (<a href="http://xarray.pydata.org/en/stable/generated/xarray.DataArray.html#xarray.DataArray" title="xarray.DataArray"><code class="language-plaintext highlighter-rouge">DataArray</code></a> objects) with aligned dimensions. It is designed as an in-memory representation of the data model from the <a href="http://www.unidata.ucar.edu/software/netcdf/">netCDF</a> file format.</p>
<h4 id="dataset的四类要素property">Dataset的四类要素property</h4>
<ul>
  <li>dims: a dictionary mapping from dimension names to the fixed length of each dimension (e.g., <code class="language-plaintext highlighter-rouge">{'x': 6, 'y': 6, 'time': 8}</code>)</li>
  <li>data_vars: : a dict-like container of DataArrays corresponding to variables</li>
  <li>coords: another dict-like container of DataArrays intended to label points used in <code class="language-plaintext highlighter-rouge">data_vars</code> (e.g., arrays of numbers, datetime objects or strings)</li>
  <li>attrs: <a href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.9)"><code class="language-plaintext highlighter-rouge">dict</code></a> to hold arbitrary metadata
<img src="http://xarray.pydata.org/en/stable/_images/dataset-diagram.png" alt="_images/dataset-diagram.png" />
In this example, it would be natural to call <code class="language-plaintext highlighter-rouge">temperature</code> and <code class="language-plaintext highlighter-rouge">precipitation</code> “data variables” and all the other arrays “coordinate variables” because they label the points along the dimensions. (see <a href="http://xarray.pydata.org/en/stable/data-structures.html#id8">1</a> for more background on this example).
    <h4 id="creating-a-dataset">Creating a Dataset</h4>
  </li>
  <li><code class="language-plaintext highlighter-rouge">data_vars</code> should be a dictionary with each key as the name of the variable and each value as one of:
    <ul>
      <li>A <a href="http://xarray.pydata.org/en/stable/generated/xarray.DataArray.html#xarray.DataArray" title="xarray.DataArray"><code class="language-plaintext highlighter-rouge">DataArray</code></a> or <a href="http://xarray.pydata.org/en/stable/generated/xarray.Variable.html#xarray.Variable" title="xarray.Variable"><code class="language-plaintext highlighter-rouge">Variable</code></a></li>
      <li>A tuple of the form <code class="language-plaintext highlighter-rouge">(dims, data[, attrs])</code>, which is converted into arguments for <a href="http://xarray.pydata.org/en/stable/generated/xarray.Variable.html#xarray.Variable" title="xarray.Variable"><code class="language-plaintext highlighter-rouge">Variable</code></a></li>
      <li>A pandas object, which is converted into a <code class="language-plaintext highlighter-rouge">DataArray</code></li>
      <li>A 1D array or list, which is interpreted as values for a one dimensional coordinate variable along the same dimension as it’s name</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">coords</code> should be a dictionary of the same form as <code class="language-plaintext highlighter-rouge">data_vars</code>.</li>
  <li><code class="language-plaintext highlighter-rouge">attrs</code> should be a dictionary.</li>
</ul>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">temp</span> <span class="o">=</span> <span class="mi">15</span><span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">precip</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
<span class="n">lon</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">99.83</span><span class="p">,</span><span class="o">-</span><span class="mf">99.32</span><span class="p">],[</span><span class="o">-</span><span class="mf">99.79</span><span class="p">,</span><span class="o">-</span><span class="mf">99.23</span><span class="p">]]</span>
<span class="n">lat</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">42.25</span><span class="p">,</span><span class="mf">42.21</span><span class="p">],[</span><span class="mf">42.63</span><span class="p">,</span><span class="mf">42.59</span><span class="p">]]</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">Dataset</span><span class="p">({</span>
    <span class="s">'temperature'</span><span class="p">:([</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">,</span><span class="s">'time'</span><span class="p">],</span><span class="n">temp</span><span class="p">),</span>
    <span class="s">'precipitation'</span><span class="p">:([</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">,</span><span class="s">'time'</span><span class="p">],</span><span class="n">precip</span><span class="p">),</span>
<span class="p">},</span>
<span class="n">coords</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">'lon'</span><span class="p">:([</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">],</span><span class="n">lon</span><span class="p">),</span>
    <span class="s">'lat'</span><span class="p">:([</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">],</span><span class="n">lat</span><span class="p">),</span>
    <span class="s">'time'</span><span class="p">:</span><span class="n">pd</span><span class="p">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">'2014-09-06'</span><span class="p">,</span><span class="n">periods</span><span class="o">=</span><span class="mi">3</span><span class="p">),</span>
    <span class="s">'reference_time'</span><span class="p">:</span><span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s">'2014-09-05'</span><span class="p">),</span>
<span class="p">},)</span>

<span class="n">ds</span>
<span class="n">ds</span><span class="p">.</span><span class="n">data_vars</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span>
<span class="n">ds</span><span class="p">.</span><span class="n">temperature</span>
<span class="c1">#此处可以发现，xy其实是工具人，只代表维度，真正能发挥作用的是lat和lon坐标
</span></code></pre></div></div>
<h4 id="dataset-contents">Dataset contents</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">'temperature'</span> <span class="ow">in</span> <span class="n">ds</span>
<span class="n">ds</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">]</span>
</code></pre></div></div>
<h4 id="dictionary-like-methods">Dictionary like methods</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">Dataset</span><span class="p">()</span>
<span class="n">ds</span><span class="p">[</span><span class="s">"temperature"</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s">"x"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">,</span> <span class="s">"time"</span><span class="p">),</span> <span class="n">temp</span><span class="p">)</span>
<span class="n">ds</span><span class="p">[</span><span class="s">"temperature_double"</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s">"x"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">,</span> <span class="s">"time"</span><span class="p">),</span> <span class="n">temp</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ds</span><span class="p">[</span><span class="s">"precipitation"</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s">"x"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">,</span> <span class="s">"time"</span><span class="p">),</span> <span class="n">precip</span><span class="p">)</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">"lat"</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s">"x"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">),</span> <span class="n">lat</span><span class="p">)</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">"lon"</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s">"x"</span><span class="p">,</span> <span class="s">"y"</span><span class="p">),</span> <span class="n">lon</span><span class="p">)</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">"time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">"2014-09-06"</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">"reference_time"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">Timestamp</span><span class="p">(</span><span class="s">"2014-09-05"</span><span class="p">)</span>


</code></pre></div></div>
<h4 id="拷贝删除创建副本">拷贝、删除、创建副本</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#弱复制，只是容器被复制，源文件不变
</span><span class="n">ds</span><span class="p">.</span><span class="n">drop_vars</span><span class="p">[</span><span class="s">'temperature'</span><span class="p">]</span>
<span class="n">ds</span><span class="p">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s">'time'</span><span class="p">)</span>
<span class="n">ds</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">temperature2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span> <span class="n">ds</span><span class="p">.</span><span class="n">tempeture</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="pipe方法">pipe()方法</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">ds</span><span class="p">.</span><span class="n">temperature</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">pipe</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span><span class="n">x</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="s">'y'</span><span class="p">).</span><span class="n">pipe</span><span class="p">(</span><span class="n">plt</span><span class="p">.</span><span class="n">plot</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="xarray鼓励创建新dataset">Xarray鼓励创建新dataset</h4>
<p>With xarray, there is no performance penalty for creating new datasets, even if variables are lazily loaded from a file on disk. Creating new objects instead of mutating existing objects often results in easier to understand code, so we encourage using this approach.</p>
<h4 id="变换坐标系swap_dims">变换坐标系，swap_dims()</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">[</span><span class="s">'day'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s">'time'</span><span class="p">,[</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">])</span>
<span class="n">ds</span><span class="p">.</span><span class="n">swap_dims</span><span class="p">({</span><span class="s">'time'</span><span class="p">:</span><span class="s">'day'</span><span class="p">})</span> <span class="c1">#把time坐标系替换为day坐标系
</span></code></pre></div></div>
<h3 id="coordinates">Coordinates</h3>
<h4 id="dimension-coordinates-cfdimension-coordinates">dimension coordinates (CF：dimension coordinates)</h4>
<ul>
  <li>与dimension的name保持一致，使用pandas.Index来store their values
    <h4 id="non-dimension-coordinatescfauxiliary-coordinate-variables">non-dimension coordinates（CF：auxiliary coordinate variables）</h4>
  </li>
  <li>are variables that contain coordinate data, but are not a dimension coordinate. They can be multidimensional (see <a href="http://xarray.pydata.org/en/stable/examples/multidimensional-coords.html">Working with Multidimensional Coordinates</a>), and there is no relationship between the name of a non-dimension coordinate and the name(s) of its dimension(s). Non-dimension coordinates can be useful for indexing or plotting; otherwise, xarray does not make any direct use of the values associated with them. They are not used for alignment or automatic indexing, nor are they required to match when doing arithmetic (see <a href="http://xarray.pydata.org/en/stable/computation.html#coordinates-math">Coordinates</a>).</li>
</ul>

<h4 id="modifying-coordinates-and-coordinate-methods">Modifying coordinates and coordinate methods</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">reset_coords</span><span class="p">()</span>
<span class="n">ds</span><span class="p">.</span><span class="n">set_coords</span><span class="p">([</span><span class="s">'temperature'</span><span class="p">,</span><span class="s">'precipitation'</span><span class="p">])</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">to_dataset</span><span class="p">()</span>
<span class="n">ds</span><span class="p">.</span><span class="n">coords</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">alt</span><span class="p">.</span><span class="n">coords</span><span class="p">)</span>
<span class="n">ds</span><span class="p">[</span><span class="s">'time'</span><span class="p">].</span><span class="n">to_index</span><span class="p">()</span>
<span class="n">ds</span><span class="p">.</span><span class="n">indexes</span>
</code></pre></div></div>
<p>####</p>
<h2 id="indexing-and-selecting-data">Indexing and selecting data</h2>
<p>x[dict(space=0)]  = x.isel(space=0)
x.loc[dict(space=’IA’)] = x.sel(space=’IA’)
并无iloc，而是dict或者isel</p>
<h3 id="positional-indexing">Positional indexing</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s">"time"</span><span class="p">,</span> <span class="n">pd</span><span class="p">.</span><span class="n">date_range</span><span class="p">(</span><span class="s">"2000-01-01"</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="mi">4</span><span class="p">)),</span>
        <span class="p">(</span><span class="s">"space"</span><span class="p">,</span> <span class="p">[</span><span class="s">"IA"</span><span class="p">,</span> <span class="s">"IL"</span><span class="p">,</span> <span class="s">"IN"</span><span class="p">]),</span>
    <span class="p">],</span>
<span class="p">)</span>
<span class="n">da</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span>
<span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>
<span class="n">da</span><span class="p">[:,[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
<span class="n">da</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"2000-01-01"</span><span class="p">:</span><span class="s">"2000-01-02"</span><span class="p">,</span> <span class="s">"IA"</span><span class="p">]</span>
<span class="n">da</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="s">"2000-01-01"</span><span class="p">,</span> <span class="p">[</span><span class="s">"IL"</span><span class="p">,</span> <span class="s">"IN"</span><span class="p">]]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span> <span class="c1">#Dataset不支持此类赋值方式，只有DataArray支持
</span></code></pre></div></div>
<h3 id="indexing-with-dimension-names">Indexing with dimension names</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sel</span><span class="p">()</span><span class="n">和isel</span><span class="p">()</span> <span class="n">method</span>
<span class="n">da</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">time</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">da</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'2000-01-01'</span><span class="p">,</span><span class="s">'2000-01-02'</span><span class="p">))</span>
</code></pre></div></div>
<h3 id="nearest-neighbor-lookups">Nearest neighbor lookups</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">sel</span><span class="p">(),</span> <span class="n">reindex</span><span class="p">(),</span> <span class="n">reindex_like</span><span class="p">()</span> <span class="nb">all</span> <span class="n">support</span> <span class="s">'method'</span> <span class="ow">and</span> <span class="s">'tolerance'</span> <span class="n">keyword</span> <span class="n">argument</span><span class="p">,</span> <span class="n">但是不支持配合slice的sel函数</span><span class="err">，</span><span class="n">但slice本身就可以挑选在其内的xarray</span>
<span class="n">method</span><span class="p">:</span> <span class="n">pad</span><span class="p">,</span> <span class="n">backfill</span><span class="p">,</span> <span class="n">nearest</span> <span class="c1">#此处前两者用法需要进一步了解
</span><span class="n">da</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">1.1</span><span class="p">,</span><span class="mf">1.9</span><span class="p">],</span><span class="n">method</span> <span class="o">=</span> <span class="s">'nearest'</span><span class="p">)</span>
<span class="n">da</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s">'backfill'</span><span class="p">)</span>
<span class="n">da</span><span class="p">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">].</span><span class="n">method</span><span class="o">=</span><span class="s">'pad'</span><span class="p">)</span>
<span class="n">reversed_da</span> <span class="o">=</span> <span class="n">da</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">reversed_da</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="mf">3.1</span><span class="p">:</span><span class="mf">0.9</span><span class="p">]</span>
</code></pre></div></div>
<h3 id="dataset-indexing">Dataset indexing</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">dataset</span>
<span class="n">ds</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#位置索引法
</span><span class="n">ds</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">time</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

<span class="n">ds</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s">'2000-01-01'</span><span class="p">)</span> <span class="c1">#标签索引法
</span><span class="n">ds</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s">'2000-01-01'</span><span class="p">)]</span>

</code></pre></div></div>
<h3 id="dropping-labels-and-dimensions">Dropping labels and dimensions</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">drop_sel</span><span class="p">()</span> <span class="c1">#both for Dataset and DataArray
</span><span class="n">ds</span><span class="p">.</span><span class="n">drop_dims</span><span class="p">()</span>
</code></pre></div></div>
<h3 id="masking-with-where">Masking with where</h3>
<p>索引的方法普遍返回一个数据集的子集，但是有时候需要保留原有数据集的形状（shape），因此可以采用where的用法</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">16</span><span class="p">).</span><span class="n">reshape</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">])</span>
<span class="n">da</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">da</span><span class="p">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
<span class="n">da</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">da</span><span class="p">.</span><span class="n">y</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="selecting-values-with-isin">Selecting values with isin</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span> <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s">"x"</span><span class="p">])</span>
<span class="n">da</span><span class="p">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>

<span class="c1">#isin与where配合
</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s">'x'</span><span class="p">])</span>
<span class="n">da</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">lookup</span><span class="p">.</span><span class="n">isin</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">4</span><span class="p">]),</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="c1">#但以上速度明显慢于sel()用法
</span></code></pre></div></div>
<h3 id="vectorized-indexing-比较难的一节">Vectorized Indexing (比较难的一节)</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">da</span> <span class="ow">is</span> <span class="n">DataArray</span>
<span class="n">da</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">]]</span>

<span class="n">ind_x</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s">'x'</span><span class="p">])</span>
<span class="n">ind_y</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s">'y'</span><span class="p">])</span>
<span class="n">ind</span> <span class="o">=</span> <span class="n">xr</span><span class="p">.</span><span class="n">DataArray</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]],</span><span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="s">'a'</span><span class="p">,</span><span class="s">'b'</span><span class="p">])</span>
<span class="n">da</span><span class="p">[</span><span class="n">ind_x</span><span class="p">,</span><span class="n">ind_y</span><span class="p">]</span> <span class="n">正交索引</span>
<span class="n">da</span><span class="p">[</span><span class="n">ind_x</span><span class="p">,</span><span class="n">ind_x</span><span class="p">]</span> <span class="n">向量索引</span>
<span class="n">da</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span>
</code></pre></div></div>
<h3 id="assigning-values-with-indexing">Assigning values with indexing</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">赋值</span><span class="err">：</span> <span class="p">.</span><span class="n">loc</span><span class="p">()</span><span class="err">，</span> <span class="p">.</span><span class="n">where</span><span class="p">()</span> <span class="p">.</span><span class="n">向量化方式</span><span class="err">（</span><span class="n">难的那一节</span><span class="err">）</span>
<span class="n">不要使用isel和sel函数赋值</span><span class="err">，</span><span class="n">会失败</span>
<span class="n">Dask包无法使用并行赋值</span>
</code></pre></div></div>
<h3 id="more-advanced-indexing">More advanced indexing</h3>
<blockquote>
  <p>source: <a href="http://xarray.pydata.org/en/stable/indexing.html#more-advanced-indexing">More advanced indexing</a></p>
  <h3 id="align-and-reindex">Align and reindex</h3>
  <p><a href="http://xarray.pydata.org/en/stable/indexing.html#align-and-reindex">Align and reindex</a></p>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">.</span><span class="n">reindex</span><span class="p">()</span>
<span class="p">.</span><span class="n">reindex_like</span><span class="p">()</span>
<span class="p">.</span><span class="n">align</span><span class="p">(</span><span class="n">join</span><span class="o">=</span><span class="n">outer</span><span class="p">,</span><span class="n">inner</span><span class="p">,</span><span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">)</span>
</code></pre></div>  </div>
  <h3 id="missing-coordinate-labels">Missing coordinate labels</h3>
  <p>source: <a href="http://xarray.pydata.org/en/stable/indexing.html#missing-coordinate-labels">Missing coordinate labels</a></p>
  <h3 id="underlying-indexes">Underlying Indexes</h3>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">da</span> <span class="ow">is</span> <span class="n">Xarray</span>
<span class="n">da</span><span class="p">.</span><span class="n">indexes</span><span class="p">[</span><span class="s">'time'</span><span class="p">]</span>  <span class="n">和</span><span class="p">.</span><span class="n">coords类似</span>
</code></pre></div>  </div>
  <h3 id="coples-vs-views">Coples vs. Views</h3>
  <p>source: <a href="http://xarray.pydata.org/en/stable/indexing.html#copies-vs-views">Copies vs. Views</a></p>
  <ul>
    <li>Positional indexing with only integers and slices returns a view.</li>
    <li>Positional indexing with arrays or lists returns a copy.</li>
    <li>Label-based indexing with only slices returns a view.</li>
    <li>Label-based indexing with arrays returns a copy.</li>
    <li>Label-based indexing with scalars returns a view or a copy, depending upon if the corresponding positional indexer can be represented as an integer or a slice object. The exact rules are determined by pandas.
      <h3 id="multi-level-indexing">Multi-level indexing</h3>
      <p>source: <a href="http://xarray.pydata.org/en/stable/indexing.html#multi-level-indexing">Multi-level indexing</a></p>
      <h3 id="indexing-rules">Indexing rules</h3>
      <p>source: <a href="http://xarray.pydata.org/en/stable/indexing.html#indexing-rules">Indexing rules</a></p>
      <h2 id="interpolating-data">Interpolating data</h2>
      <h3 id="scalar-and-1-dimensional-interpolation">Scalar and 1-dimensional interpolation</h3>
      <p>```python
da is xarray
da.interp(time=2.5)
da.interp(time=[2,5,3.5])</p>
    </li>
  </ul>
</blockquote>

<p>da_dt64 = xr.DataArray([1,3],[(‘time’,pd.date_range(‘1/1/2000’,’1/3/2000’,periods=2))])
da_dt64.interp(time=’2000-01-02’)
da_dt64.interp(time=pd.date_range(‘1/1/2000’,’1/3/2000’,periods=3))</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Multi-dimensional Interpolation
```python
da.interp(time=2.5,space=0.15)
#interp_like
other = xr.DataArray(np.sin(0.4*np.arange(9).reshape(3,3)),[('time',[0.9,1.9,2.9]),('space',[0.15,0.25,0.35])])
interpolated = da.interp_like(other)
interpolated
</code></pre></div></div>
<h3 id="interpolation-methods">Interpolation methods</h3>
<blockquote>
  <p><a href="http://xarray.pydata.org/en/stable/interpolation.html#interpolation-methods">Interpolation methods</a></p>
  <h3 id="advanced-interpolation">Advanced Interpolation</h3>
  <p><img src="http://xarray.pydata.org/en/stable/_images/advanced_selection_interpolation.svg" alt="advanced indexing and interpolation|500" />
<a href="http://xarray.pydata.org/en/stable/interpolation.html#advanced-interpolation">Advanced Interpolation</a></p>
  <h3 id="interpolating-arrays-with-nan">Interpolating arrays with Nan</h3>
  <p><a href="http://xarray.pydata.org/en/stable/interpolation.html#advanced-interpolation">Advanced Interpolation</a>](http://xarray.pydata.org/en/stable/interpolation.html#interpolating-arrays-with-nan)</p>
  <h3 id="example">Example</h3>
  <p><a href="http://xarray.pydata.org/en/stable/interpolation.html#example">Example</a></p>
  <h2 id="computation-1">Computation</h2>
  <h3 id="basic-array-math">Basic array math</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#basic-array-math">Basic array math</a></p>
  <h3 id="misssing-values">Misssing values</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#missing-values">Missing values</a></p>
  <h3 id="aggregation">Aggregation</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#aggregation">Aggregation</a></p>
  <h3 id="rolling-window-operations">Rolling window operations</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#rolling-window-operations">Rolling window operations</a></p>
  <h3 id="weighted-array-reductions">Weighted array reductions</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#weighted-array-reductions">Weighted array reductions</a></p>
  <h3 id="coarsen-large-arrays">Coarsen large arrays</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#coarsen-large-arrays">Coarsen large arrays
</a></p>
  <h3 id="computation-using-coordinates">Computation using Coordinates</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#computation-using-coordinates">Computation using Coordinates</a></p>
  <h3 id="fitting-polynomials">Fitting polynomials</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#fitting-polynomials">Fitting polynomials</a></p>
  <h3 id="broadcasting-by-dimension-name">Broadcasting by dimension name</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#broadcasting-by-dimension-name">Broadcasting by dimension name</a></p>
  <h3 id="automatic-alignment">Automatic alignment</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#automatic-alignment">Automatic alignment</a></p>
  <h3 id="coordinates-1">Coordinates</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#coordinates">Coordinates</a></p>
  <h3 id="math-with-datasets">Math with datasets</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#math-with-datasets">Math with datasets</a></p>
  <h3 id="wrapping-custon-computation">Wrapping custon computation</h3>
  <p><a href="http://xarray.pydata.org/en/stable/computation.html#wrapping-custom-computation">Wrapping custom computation</a></p>
  <h2 id="groupby-split-apply-combine">Groupby: Split-apply-combine</h2>
  <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span> <span class="ow">is</span> <span class="n">dataset</span>
<span class="p">.</span><span class="n">groupby</span><span class="p">()</span>
<span class="p">.</span><span class="n">groups</span>
<span class="p">.</span><span class="nb">sum</span><span class="p">()</span>
<span class="p">.</span><span class="n">mean</span><span class="p">()</span>
<span class="p">,</span><span class="nb">map</span><span class="p">()</span>
</code></pre></div>  </div>
  <p><a href="http://xarray.pydata.org/en/stable/groupby.html">GroupBy: split-apply-combine</a></p>
  <h2 id="reshaping-and-reorganizing-data">Reshaping and reorganizing data</h2>
  <p><a href="http://xarray.pydata.org/en/stable/reshaping.html">Reshaping and reorganizing data</a>
```python
transpose() #调换维度顺序
expand_dims() #增加维度
squeeze() #减少维度
to_array() #dataset to dataarray
to_dataset() #dataarray to dataset</p>
</blockquote>

<p>stack()
unstack()</p>

<p>to_stacked_array()
to_unstacked_dataset()</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### xarray使用sel的方法
```python
set_index() #创造Multiindex
reset_index() #解除Multiindex
</code></pre></div></div>
<blockquote>
  <p><a href="http://xarray.pydata.org/en/stable/reshaping.html#set-and-reset-index">Set and reset index</a></p>
</blockquote>

<h2 id="combining-data">Combining data</h2>
<blockquote>
  <p><a href="http://xarray.pydata.org/en/stable/combining.html">Combining data</a></p>
  <h2 id="time-series-data">Time series data</h2>
  <p><a href="http://xarray.pydata.org/en/stable/time-series.html">Time series data</a></p>
  <h2 id="weather-and-climate-data">Weather and climate data</h2>
  <p><a href="http://xarray.pydata.org/en/stable/weather-climate.html">Weather and climate data</a></p>
  <h2 id="working-with-pandas">Working with pandas</h2>
  <p><a href="http://xarray.pydata.org/en/stable/pandas.html">Working with pandas</a>
```python
for dataset
to_dataframe()
from_dataframe()</p>
</blockquote>

<p>for dataarray
to_series()
from_series()
to_pandas() #一维series，二维dataframe</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### 对面板数据的支持
```python
data = np.random.RandomState(0).rand(2, 3, 4)

items = list("ab")

major_axis = list("mno")

minor_axis = pd.date_range(start="2000", periods=4, name="date")
array = xr.DataArray(data, [items, major_axis, minor_axis])

</code></pre></div></div>
<p>A DataArray’s data is stored as a numpy array, and so can only contain a single type. As a result, a Panel that contains <a href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.html#pandas.DataFrame" title="(in pandas v1.1.4)"><code class="language-plaintext highlighter-rouge">DataFrame</code></a> objects with multiple types will be converted to <code class="language-plaintext highlighter-rouge">dtype=object</code>. A <code class="language-plaintext highlighter-rouge">Dataset</code> of multiple <code class="language-plaintext highlighter-rouge">DataArray</code> objects each with its own dtype will allow original types to be preserved.</p>
<h2 id="reading-and-writing-file">Reading and writing file</h2>
<blockquote>
  <p><a href="http://xarray.pydata.org/en/stable/io.html">Reading and writing files</a></p>
  <h2 id="parallel-computing-with-dask">Parallel computing with Dask</h2>
  <h2 id="plotting-1">Plotting</h2>
  <h2 id="working-with-numpy-like-arrays">Working with numpy-like arrays</h2>
</blockquote>

<h2 id="basic-xarray-notebook">Basic xarray notebook</h2>

<h3 id="reading-data-and-associated-metadata-from-a-netcdf-file-into-an-xarray-dataset">Reading data and associated metadata from a netCDF file into an xarray dataset</h3>
<p>An xarray <a href="http://xarray.pydata.org/en/stable/data-structures.html#dataset">dataset</a> is a container for data and it’s associated metadata, including labelled coordinates.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">xarray</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xarray</span><span class="p">.</span><span class="n">open_dataset</span><span class="p">()</span> <span class="c1">#nc 文件
</span></code></pre></div></div>
<p>Dimensions, Coordinates
<code class="language-plaintext highlighter-rouge">Dimensions</code> give the size of each named dimension. This is a CF-compliant (<a href="http://cfconventions.org/">http://cfconventions.org</a>) dataset, which means any variable which has the same name as a dimension is assumed to be a coordinate. There are other metadata which may be used to denote a coordinate. In this case <code class="language-plaintext highlighter-rouge">xarray</code> signifies coordinates associated with variables with <code class="language-plaintext highlighter-rouge">*</code>.
Data variables, Attributes
<code class="language-plaintext highlighter-rouge">Data variables</code> lists all the variables that are not coordinates. In this case three of them are <strong>bounds variables, definining the beginning and end values for the three coordinates</strong>. The only true data variables is <code class="language-plaintext highlighter-rouge">tas</code>（本notebook的例子）.</p>

<p>Data variables储存在</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">.</span><span class="n">data_vars</span> <span class="c1">#变量介绍
</span><span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
    <span class="n">time</span>\<span class="n">_bnds</span>  <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">bnds</span><span class="p">)</span> <span class="n">datetime64</span>\<span class="p">[</span><span class="n">ns</span>\<span class="p">]</span> <span class="mi">1850</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span> <span class="mi">1850</span><span class="o">-</span><span class="mi">02</span><span class="o">-</span><span class="mi">01</span> <span class="p">...</span> <span class="mi">2006</span><span class="o">-</span><span class="mi">01</span><span class="o">-</span><span class="mi">01</span>
    <span class="n">lat</span>\<span class="n">_bnds</span>   <span class="p">(</span><span class="n">lat</span><span class="p">,</span> <span class="n">bnds</span><span class="p">)</span> <span class="n">float64</span> <span class="o">-</span><span class="mf">90.0</span> <span class="o">-</span><span class="mf">89.38</span> <span class="o">-</span><span class="mf">89.38</span> <span class="p">...</span> <span class="mf">89.38</span> <span class="mf">89.38</span> <span class="mf">90.0</span>
    <span class="n">lon</span>\<span class="n">_bnds</span>   <span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">bnds</span><span class="p">)</span> <span class="n">float64</span> <span class="o">-</span><span class="mf">0.9375</span> <span class="mf">0.9375</span> <span class="mf">0.9375</span> <span class="p">...</span> <span class="mf">357.2</span> <span class="mf">357.2</span> <span class="mf">359.1</span>
    <span class="n">tas</span>        <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span> <span class="n">lon</span><span class="p">)</span> <span class="n">float32</span> <span class="p">...</span>

<span class="c1">#以上都是ds dataset的DataArray
</span><span class="n">循环print变量名称</span>

<span class="k">for</span> <span class="n">varname</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
	<span class="k">print</span><span class="p">(</span><span class="n">varnanme</span><span class="p">)</span>
</code></pre></div></div>

<p>获取变量</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ds</span><span class="p">[</span><span class="s">'tas'</span><span class="p">]</span>
</code></pre></div></div>

<h3 id="subsetting-a-dataset-by-time-and-space-slicing-and-dicing">Subsetting a dataset by time and space （Slicing and Dicing）</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">tas</span>
<span class="n">tas</span><span class="p">.</span><span class="n">shape</span>
<span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="c1">#与上命令一样,Return a new array indexed along the specified dimension(s).
</span></code></pre></div></div>

<h4 id="sel函数">’‘.sel’函数</h4>
<p>The power of xarray comes with the close association of data with coordinates. So it is possible to use the equivalent `.sel` operator but with coordinate values. For example, to select an area that includes the Indian Ocean and Australia use `slice` to indicate the range of latitude and longitude values required and pass as key/value pairs to `sel`. <strong>`slice` will include coordinate values less than or equal to the upper bound</strong>, not like `range` in basic python that excludes the upper bound （如果是一段区间，则sel函数里面包含了左值和右值） 我怀疑isel的slice不是如此</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="isel和sel的组合使用">isel和sel的组合使用</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="sel和精确时间的搭配">sel和精确时间的搭配</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s">'1850-01-16T12:00:00'</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span> <span class="c1">#如果是一段区间，则sel函数里面包含了左值和右值
</span><span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'1871-03'</span><span class="p">,</span><span class="s">'1871-11'</span><span class="p">),</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">))</span>
</code></pre></div></div>

<h4 id="获取某一点最近的cell数据">获取某一点最近的cell数据</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">cel</span><span class="p">(</span><span class="n">lat</span><span class="o">=-</span><span class="mf">27.47</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="mf">153.03</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="plotting-with-xarray">Plotting with xarray</h3>
<p>The <a href="http://xarray.pydata.org/en/stable/plotting.html">documentation of the xarray plot function is excellent</a>. Read it for an in-depth explanation of the power of the xarray plotting functionality. This notebook covers just enough to get started and make use of plots in subsequent tutorials.
注意：xarray的plot函数只适用于DataArray而不适用于Dataset</p>

<h4 id="初步dataarray绘图">初步DataArray绘图</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span> <span class="o">=</span> <span class="n">ds</span><span class="p">.</span><span class="n">tas</span>
<span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="链式筛选isel和sel搭配使用绘图">链式筛选：isel和sel搭配使用绘图</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">sel</span><span class="p">(</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div></div>
<h4 id="xarray将会自动识别数据类型选择绘图样式">xarray将会自动识别数据类型，选择绘图样式</h4>
<ul>
  <li>如果维度过高，将默认绘制长条图，例如：
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'1871-01'</span><span class="p">,</span><span class="s">'1876-12'</span><span class="p">),</span><span class="n">lon</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">160</span><span class="p">),</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span><span class="mi">25</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#这句命令运行速度极慢，发现原因是远程的问题，如果文件在本地，则很快
</span></code></pre></div>    </div>
  </li>
  <li>如果制定某一坐标点，将会返回时间序列值，例如
    <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'1871-01'</span><span class="p">,</span><span class="s">'1876-12'</span><span class="p">)).</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=-</span><span class="mf">27.47</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="mf">153.03</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s">'nearest'</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="calculating-metrics-eg-mean-maximum">Calculating metrics, e.g. mean, maximum</h3>
<h4 id="计算平均温度">计算平均温度</h4>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">mean</span><span class="p">()</span> <span class="c1">#总的
</span><span class="n">tas</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s">'time'</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#针对某一dimension
</span><span class="n">tas_clim</span> <span class="o">=</span> <span class="n">tas</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'1960-01'</span><span class="p">,</span><span class="s">'1989-12'</span><span class="p">)).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s">'time'</span><span class="p">)</span><span class="c1">#针对某一时段的某一dimension（30年）
</span></code></pre></div></div>
<h4 id="异常值计算">异常值计算</h4>
<p>The anomaly from the 30 year climatology can now be calculated by subtracting it from the original data. xarray checks which named coordinates match between the two data sets, and <em>broadcasts</em> the <code class="language-plaintext highlighter-rouge">tas_clim</code> data along the missing <code class="language-plaintext highlighter-rouge">time</code> dimension automatically</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas_anom</span> <span class="o">=</span> <span class="p">(</span><span class="n">tas</span><span class="o">-</span><span class="n">tas_clim</span><span class="p">)</span> <span class="c1">#xarray会自动广播tas_clim这一平均值至tas每一年
</span><span class="n">tas_anom</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'1960-01'</span><span class="p">,</span><span class="bp">None</span><span class="p">)).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#mean(dim='lat','lon')
</span></code></pre></div></div>
<h3 id="grouping-and-resampling-in-time">Grouping and resampling in time</h3>
<p>xarray was developed as an n-dimensional extension of <a href="https://pandas.pydata.org/">pandas</a>, a very powerful data analysis library designed primarily for tabular data and time series analysis.</p>

<p>As a result xarray can utilise much of the time series manipulation power of pandas. The relevant xarray documentation is contained in the <a href="http://xarray.pydata.org/en/stable/groupby.html">GroupBy</a> and <a href="http://xarray.pydata.org/en/stable/time-series.html">Time series data</a> sections.</p>

<p>In this case we need to do some extra imports to avoid pandas emitting warnings</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">xarray</span><span class="p">,</span> <span class="n">matplotlib</span><span class="p">.</span><span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">pandas.plotting</span> <span class="kn">import</span> <span class="n">register_matplotlib_converters</span>
<span class="n">register_matplotlib_converters</span> <span class="c1">#防止matplotlib报错pandas的时间戳问题 
</span></code></pre></div></div>

<p>register_matplotlib_converters的Url: <a href="https://www.freesion.com/article/4435362995/">因pandas版本的问题造成时间戳’Timestamp’的报错处理pandas.plotting.register_matplotlib_converters</a></p>

<h4 id="resample">Resample</h4>
<h5 id="时间分野-抽样">时间分野-抽样</h5>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas_anom_yearly</span> <span class="o">=</span> <span class="n">tas_anom</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s">'2001-01'</span><span class="p">,</span><span class="bp">None</span><span class="p">)).</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s">'Y'</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s">'time'</span><span class="p">)</span>
<span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">dims</span><span class="p">,</span> <span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">shape</span> <span class="c1">#维度和大小，后者因重抽样发生了变化
</span><span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#显示出全球升温，是指异常高温更频繁了，这里关于统计抽样的理解需要更深化（高温、Cell、温升）
</span></code></pre></div></div>

<h5 id="空间分野-抽样">空间分野-抽样</h5>
<p>依照空间抽样后的数据，南北半球分野</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">axes</span><span class="p">()</span>
<span class="n">axes</span><span class="p">.</span><span class="n">figure</span><span class="p">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">)</span>
<span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">'Global'</span><span class="p">)</span>
<span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="bp">None</span><span class="p">)).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">'Northern Hemisphere'</span><span class="p">)</span>  <span class="c1">#零纬度以北
</span><span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span><span class="mi">0</span><span class="p">)).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s">'Southern Hemisphere'</span><span class="p">)</span>  <span class="c1">#零纬度以南
</span><span class="n">plt</span><span class="p">.</span><span class="n">title</span><span class="p">(</span><span class="s">'Temperature anoalies from a 1960-1990 climatology'</span><span class="p">)</span>
<span class="n">plt</span><span class="p">.</span><span class="n">legend</span><span class="p">()</span>
</code></pre></div></div>

<h5 id="空间分野-精细化抽样">空间分野-精细化抽样</h5>
<p>To go further and split the trend more finely in latitude it is easier to use the <code class="language-plaintext highlighter-rouge">xarray.groupby_bins</code> function. It is called with a coordinate and either a number of <code class="language-plaintext highlighter-rouge">bins</code> or an array of values specifying the start and end of each bin. It returns a <code class="language-plaintext highlighter-rouge">groupby</code> object which can be iterated over, or chain a function which will applied to each group.
下文代码展示grouby_bins的作用（针对某一维度进行N等分）</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s">'lats'</span><span class="p">,</span><span class="nb">bin</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
	<span class="k">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">d</span><span class="p">.</span><span class="n">dims</span><span class="p">,</span><span class="n">d</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">groupby_bins</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="n">bins</span><span class="o">=</span><span class="mi">10</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s">'time'</span><span class="p">,</span><span class="n">hue</span><span class="o">=</span><span class="s">'lat_bins'</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<p>下文代码展示groupby的作用，以xarray的季节划分为例</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">groupby</span><span class="p">(</span><span class="s">'time.season'</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s">'time'</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">col</span><span class="o">=</span><span class="s">'season'</span><span class="p">,</span><span class="n">col_wrap</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></div>

<p>此处发现四季的缩写：</p>
<blockquote>
  <p>The results are presented for the standard seasons: winter (DJF), spring (MAM), summer (JJA), and fall (SON).
source: <a href="https://www.google.com/search?newwindow=1&amp;ei=fHYiYOLwCdGlkwW23IGADg&amp;q=four+seasons+abbreviation+DJF&amp;oq=four+seasons+abbreviation+DJF&amp;gs_lcp=CgZwc3ktYWIQAzIHCAAQsAMQHlC2gQFYy4oBYNuLAWgBcAB4AIABzz6IAc8-kgEDOS0xmAEAoAEBqgEHZ3dzLXdpesgBAcABAQ&amp;sclient=psy-ab&amp;ved=0ahUKEwjinsDj3dzuAhXR0qQKHTZuAOAQ4dUDCA0&amp;uact=5">four seasons abbreviation DJF - Google 搜索</a></p>
</blockquote>

<h3 id="masking">Masking</h3>
<p>遮盖和筛选，比如温度范围</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas0</span> <span class="o">=</span> <span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="n">第一年</span>
<span class="n">tas0</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="o">&gt;</span><span class="mi">270</span><span class="p">).</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="o">&lt;</span><span class="mi">295</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span> <span class="c1">#tas单一变量为温度，识别大于270华氏度和小于295华氏度的地方
</span></code></pre></div></div>
<p>可以应用于任何一年</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="o">&gt;</span><span class="mi">270</span><span class="p">).</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="o">&lt;</span><span class="mi">295</span><span class="p">).</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
</code></pre></div></div>
<p>也可以应用于坐标，此处where有点像if
 <strong>fills the masked areas with missing values.</strong>（如下，除标识出的大于25纬度外，其余用XX填充）</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">tas0</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="p">.</span><span class="n">lat</span><span class="o">&gt;</span><span class="mi">25</span><span class="p">,</span> <span class="mi">240</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1">#25纬度以上
</span><span class="n">tas0</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">tas0</span><span class="p">.</span><span class="n">lat</span><span class="o">&gt;</span><span class="mi">25</span><span class="p">,</span> <span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">6</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div></div>

<p>利用土地比例数据来只显示陆地气温</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">landfrac</span>
<span class="n">tas</span><span class="p">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="n">where</span><span class="p">(</span><span class="n">landfrac</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
</code></pre></div></div>

<p>利用土地比例数据来区分陆地和海洋温升</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">landfrac</span><span class="o">==</span><span class="mi">0</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'Ocean only'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
<span class="n">tas_anom_yearly</span><span class="p">.</span><span class="n">where</span><span class="p">(</span><span class="n">landfrac</span><span class="o">&gt;</span><span class="p">).</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="s">'lat'</span><span class="p">,</span><span class="s">'lon'</span><span class="p">)).</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s">'Land only'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">)</span>
</code></pre></div></div>
<h3 id="opening-multiple-files-as-a-single-dataset">Opening multiple files as a single dataset</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tas_day_ACCESS1-3_historical_r1i1p1_18500101-18741231.nc'</span><span class="p">,</span> 
        <span class="s">'tas_day_ACCESS1-3_historical_r1i1p1_18750101-18991231.nc'</span><span class="p">,</span>
        <span class="s">'tas_day_ACCESS1-3_historical_r1i1p1_19000101-19241231.nc'</span><span class="p">]</span>
<span class="n">prefix</span> <span class="o">=</span> <span class="s">'http://dapds00.nci.org.au/thredds/dodsC/rr3/CMIP5/output1/CSIRO-BOM/ACCESS1-3/historical/day/atmos/day/r1i1p1/latest/tas/'</span>
<span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span><span class="o">+</span><span class="nb">file</span> <span class="k">for</span> <span class="nb">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">]</span>
<span class="n">urls</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">xarray</span><span class="p">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="n">urls</span><span class="p">)</span>
</code></pre></div></div>

<p>#python #xarray #netCDF</p>]]></content><author><name>Chen Huang</name></author><category term="python" /><category term="GIS" /><category term="Geopandas" /><category term="可视化" /><category term="NetCDF" /><category term="xarray" /><summary type="html"><![CDATA[本文介绍了xarray软件的基本使用方法。]]></summary></entry><entry><title type="html">Multiprocessing学习笔记</title><link href="http://localhost:4000/python/2020/10/19/Multiprocess%E5%AD%A6%E4%B9%A0.html" rel="alternate" type="text/html" title="Multiprocessing学习笔记" /><published>2020-10-19T00:00:00+08:00</published><updated>2020-10-19T00:00:00+08:00</updated><id>http://localhost:4000/python/2020/10/19/Multiprocess%E5%AD%A6%E4%B9%A0</id><content type="html" xml:base="http://localhost:4000/python/2020/10/19/Multiprocess%E5%AD%A6%E4%B9%A0.html"><![CDATA[<p><strong>Multiprocessing</strong>与<strong>concurrent.futures</strong>都属于Python的内置模块，二者的功能是使得执行者能够并行地运行某一Python软件。</p>

<!--more-->
<h2 id="multiprocessing与concurrentfutures功能简介">Multiprocessing与Concurrent.futures功能简介</h2>
<p>接下来，将以“睡眠”小程序来展示多进程计算的功用。</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Sleep </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s"> second'</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s">'Done Sleeping'</span><span class="p">)</span>

<span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="p">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">do_something</span><span class="p">,</span><span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="mf">1.5</span><span class="p">])</span>
    <span class="n">p</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">processes</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
    <span class="n">process</span><span class="p">.</span><span class="n">join</span><span class="p">()</span> <span class="c1">#用于进程占用
</span>
<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Finished in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s"> second(s)'</span><span class="p">)</span>
</code></pre></div></div>
<p>结果将是：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Sleep 1.5 second
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Done Sleeping
Finished in 2.76 second(s)
</code></pre></div></div>

<p>但是还有一种更简便的方式，便是使用concurrent.futures模块：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">seconds</span><span class="p">):</span>
    <span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Sleep </span><span class="si">{</span><span class="n">seconds</span><span class="si">}</span><span class="s"> second'</span><span class="p">)</span>
    <span class="n">time</span><span class="p">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span>
    <span class="k">return</span> <span class="s">'Done Sleeping'</span> <span class="c1">#注意此处使用return而非print
</span><span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="n">f1</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">do_something</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">f2</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">do_something</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f1</span><span class="p">.</span><span class="n">result</span><span class="p">())</span>
    <span class="k">print</span><span class="p">(</span><span class="n">f2</span><span class="p">.</span><span class="n">result</span><span class="p">())</span>

<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Finished in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s"> second(s)'</span><span class="p">)</span>
</code></pre></div></div>
<p>结果将是：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sleep 1 second
Sleep 1 second
Done Sleeping
Done Sleeping
Finished in 1.06 second(s)
</code></pre></div></div>
<p>可见若使用concurrent.futures模块，将无需使用join来占用进程。</p>

<h3 id="concurrentfutures的拓展以for循环为例">Concurrent.futures的拓展：以for循环为例</h3>
<p>我们可以将上面的concurrent模块的传入参数进行泛化。</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="n">secs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="p">.</span><span class="n">submit</span><span class="p">(</span><span class="n">do_something</span><span class="p">,</span><span class="n">sec</span><span class="p">)</span> <span class="k">for</span> <span class="n">sec</span> <span class="ow">in</span> <span class="n">secs</span><span class="p">]</span> <span class="c1"># return的result列表化
</span>    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">f</span><span class="p">.</span><span class="n">result</span><span class="p">())</span>
<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Finished in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s"> second(s)'</span><span class="p">)</span>
</code></pre></div></div>
<p>结果将是：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sleep 5 second
Sleep 4 second
Sleep 2 second
Sleep 3 second
&lt;Future at 0x7fcfd6c14278 state=running&gt;
&lt;Future at 0x7fcfd6bc94a8 state=pending&gt;
&lt;Future at 0x7fcfd6bc9550 state=pending&gt;
&lt;Future at 0x7fcfd6c23400 state=pending&gt;
&lt;Future at 0x7fcfd6c23358 state=pending&gt;
Sleep 1 second
Finished in 5.08 second(s)
</code></pre></div></div>
<p>此外，除submit函数外，还可以使用map函数让代码更加简单：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">with</span> <span class="n">concurrent</span><span class="p">.</span><span class="n">futures</span><span class="p">.</span><span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
    <span class="n">secs</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">executor</span><span class="p">.</span><span class="nb">map</span><span class="p">(</span><span class="n">do_something</span><span class="p">,</span> <span class="n">secs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="n">finish</span> <span class="o">=</span> <span class="n">time</span><span class="p">.</span><span class="n">perf_counter</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="sa">f</span><span class="s">'Finished in </span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">finish</span><span class="o">-</span><span class="n">start</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s"> second(s)'</span><span class="p">)</span>
</code></pre></div></div>
<p>结果将是：</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Sleep 4 second
Sleep 5 second
Sleep 3 second
Sleep 2 second
Sleep 1 second
Done Sleeping...5
Done Sleeping...4
Done Sleeping...3
Done Sleeping...2
Done Sleeping...1
Finished in 5.1 second(s)
</code></pre></div></div>
<p>至此，本文介绍了multiprocessing和concurrent.future模块的基本并行计算功能。二者的相同点在于<strong>传导函数</strong>和<strong>输入参数</strong>，但可能concurrent模块更加简洁。</p>]]></content><author><name>Chen Huang</name></author><category term="python" /><category term="并行" /><category term="multiprocess" /><category term="python" /><summary type="html"><![CDATA[Multiprocessing与concurrent.futures都属于Python的内置模块，二者的功能是使得执行者能够并行地运行某一Python软件。]]></summary></entry><entry><title type="html">Geopandas学习笔记</title><link href="http://localhost:4000/python/2020/10/18/Geopandas%E5%AD%A6%E4%B9%A0.html" rel="alternate" type="text/html" title="Geopandas学习笔记" /><published>2020-10-18T00:00:00+08:00</published><updated>2020-10-18T00:00:00+08:00</updated><id>http://localhost:4000/python/2020/10/18/Geopandas%E5%AD%A6%E4%B9%A0</id><content type="html" xml:base="http://localhost:4000/python/2020/10/18/Geopandas%E5%AD%A6%E4%B9%A0.html"><![CDATA[<p>最近学习了Geopandas的一些基本理念和操作。此文章是为我的学习记录。Geopandas起源于Pandas，也同时整合了许多其他依赖包的功能。目前来看，Geopandas的功能能够初步满足我对数据分析的地理化呈现的基本要求。
<!--more--></p>
<h2 id="基本功能与语法">基本功能与语法</h2>
<h3 id="geopandas的引入">Geopandas的引入</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="n">pd</span> 
<span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="n">gpd</span>
<span class="kn">from</span> <span class="nn">shapely.geometry</span> <span class="kn">import</span> <span class="n">Point</span><span class="p">,</span> <span class="n">Polygon</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
</code></pre></div></div>

<h3 id="geopandas的数据读取">Geopandas的数据读取</h3>
<h4 id="shapefile文件读取">Shapefile文件读取</h4>
<p>Geopandas能够直接读取shapefile文件，此处我以中国基础地图数据为例</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pro</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">read_file</span><span class="p">(</span><span class="s">'/Users/chen/Desktop/中国基础地图数据/中国行政区.shp'</span><span class="p">)</span> 
<span class="n">pro</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>
<p>head集数据包含了省份名称和最重要的geometry列数据</p>
<h4 id="csv文件读取">CSV文件读取</h4>
<p>此处我们以中国电厂数据库为例，首先需要用pandas读取csv文件：</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwplant</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s">'/users/chen/Onedrive/Economic data/global_power_plant_database.csv'</span><span class="p">)</span>
<span class="n">pw_china</span> <span class="o">=</span> <span class="n">pwplant</span><span class="p">[</span><span class="n">pwplant</span><span class="p">.</span><span class="n">country_long</span><span class="o">==</span><span class="s">'China'</span><span class="p">]</span> <span class="c1">#选出中国数据
</span><span class="n">point_with_cap</span> <span class="o">=</span> <span class="n">pw_china</span><span class="p">[[</span><span class="s">'latitude'</span><span class="p">,</span><span class="s">'longitude'</span><span class="p">,</span><span class="s">'capacity_mw'</span><span class="p">]]</span> <span class="c1">#读取其中的经纬度和容量数据
</span><span class="n">point_withcap</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span><span class="n">drop</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">point</span> <span class="o">=</span> <span class="n">point_with_cap</span><span class="p">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="n">row</span><span class="p">.</span><span class="n">longitude</span><span class="p">,</span><span class="n">row</span><span class="p">.</span><span class="n">latitude</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#以列为方向，使用shapely的Point类将经纬度转换为point点
</span><span class="n">powerplants</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">GeoDataFrame</span><span class="p">(</span><span class="n">point_with_cap</span><span class="p">,</span><span class="n">geometry</span> <span class="o">=</span> <span class="n">point</span><span class="p">)</span> <span class="c1">#直到此处才转为Geopandas数据集
</span></code></pre></div></div>
<h4 id="crs参考坐标系统">CRS参考坐标系统</h4>
<p>参考坐标系统是每一套地理数据的标准，如果两套地理数据的CRS不同，那么二者是无法合并和比较的。比较常用的CRS标准为 epsg 4326
这里我们将读取的火电厂数据的crs默认值改为4326</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">powerplants</span><span class="p">.</span><span class="n">crs</span> <span class="o">=</span> <span class="p">{</span><span class="s">'init'</span><span class="p">:</span><span class="s">'epsg:4326'</span><span class="p">}</span>
</code></pre></div></div>
<h3 id="初步绘图">初步绘图</h3>
<p>在此我绘制四个子图例子</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">fig_spec</span> <span class="o">=</span> <span class="n">fig</span><span class="p">.</span><span class="n">add_gridspec</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="c1">#一个幕布下的四块，我很喜欢的子图切割方式
</span><span class="n">ax0</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">fig_spec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">fig_spec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">fig_spec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax3</span> <span class="o">=</span> <span class="n">plt</span><span class="p">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">fig_spec</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="n">pro</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax0</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">'grey'</span><span class="p">,</span><span class="n">edgecolor</span><span class="o">=</span><span class="s">'white'</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">pro</span><span class="p">.</span><span class="n">to_crs</span><span class="p">(</span><span class="n">epsg</span><span class="o">=</span><span class="mi">4326</span><span class="p">).</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">,</span><span class="n">cmap</span><span class="o">=</span><span class="s">'Reds'</span><span class="p">)</span>
<span class="n">powerplants</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">'green'</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">powerplants</span><span class="p">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax3</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s">'blue'</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</code></pre></div></div>
<p>如果运行正常，将如图所示
<img src="/assets/plants_subplot.jpg" alt="四个子图" /></p>

<h2 id="polygon和point的合并">Polygon和Point的合并</h2>
<p>根据之前我们之前的Shapefile文件和CSV文件的导入，以及使用Geopandas和Pandas的预处理（如经纬度转为Point，CRS转换工作等），我们现在可以开展面数据和点数据的合并工作了。这里我们将使用Geopandas中的 <strong>sjoin</strong> 函数</p>
<h3 id="点与面的合并">点与面的合并</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plants_with_pro</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">powerplants</span><span class="p">,</span><span class="n">pro</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">'inner'</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="s">'within'</span><span class="p">)</span> <span class="c1">#注意此处使用within
</span><span class="n">plants_with_pro</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>
<h3 id="面与点的合并">面与点的合并</h3>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pro_with_plants</span> <span class="o">=</span> <span class="n">gpd</span><span class="p">.</span><span class="n">sjoin</span><span class="p">(</span><span class="n">pro</span><span class="p">,</span><span class="n">powerplants</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">'inner'</span><span class="p">,</span><span class="n">op</span><span class="o">=</span><span class="s">'contains'</span><span class="p">)</span> <span class="c1">#注意此处使用contains
</span><span class="n">pro_with_plants</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>
<h3 id="统计简化和绘图">统计、简化和绘图</h3>
<p>正常的话，以上两种合并方式所获得的数据规模应该是一样的</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">print</span><span class="p">(</span><span class="n">plants_with_pro</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">pro_with_plants</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
</code></pre></div></div>
<p>我本人所显示的是(2938,15)
在绘图之前，我们可能会想到一个问题，那就是我们可能需要2900多个点绘制，但是我们不需要这么多次的面绘制。这里就需要对所合并数据集进行简化。以一个省份的电厂数量为例，我们进行数据简化和绘图。</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plants_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pro_with_plants</span><span class="p">[</span><span class="s">'NAME'</span><span class="p">].</span><span class="n">value_counts</span><span class="p">())</span> <span class="c1">#统计每个省份的电厂数量
</span><span class="n">plants_counts</span><span class="p">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">plants_counts</span><span class="p">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div></div>
<p>显示的结果应该为：</p>

<table>
  <thead>
    <tr>
      <th style="text-align: center"> </th>
      <th style="text-align: center">index</th>
      <th style="text-align: center">NAME</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: center">0</td>
      <td style="text-align: center">内蒙古</td>
      <td style="text-align: center">295</td>
    </tr>
    <tr>
      <td style="text-align: center">1</td>
      <td style="text-align: center">四川</td>
      <td style="text-align: center">228</td>
    </tr>
    <tr>
      <td style="text-align: center">2</td>
      <td style="text-align: center">云南</td>
      <td style="text-align: center">212</td>
    </tr>
    <tr>
      <td style="text-align: center">3</td>
      <td style="text-align: center">山东</td>
      <td style="text-align: center">159</td>
    </tr>
    <tr>
      <td style="text-align: center">4</td>
      <td style="text-align: center">新疆</td>
      <td style="text-align: center">148</td>
    </tr>
  </tbody>
</table>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plants_counts</span><span class="p">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">{</span><span class="s">'index'</span><span class="p">:</span><span class="s">'name'</span><span class="p">,</span><span class="s">'NAME'</span><span class="p">:</span><span class="s">'plants_num'</span><span class="p">},</span><span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="c1">#这里改一下列名
</span></code></pre></div></div>
<p>至此为止，合并数据集已经发挥了它的全部使命，即将电厂与省份匹配然后计算每一省份的电厂数量。
接下来，需要的是将统计好的数量数据与原有 <strong>pro</strong> 对象合并</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pro</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="n">merge</span><span class="p">(</span><span class="n">pro</span><span class="p">,</span><span class="n">plants_counts</span><span class="p">,</span><span class="n">left_on</span><span class="o">=</span><span class="s">'NAME'</span><span class="p">,</span><span class="n">right_on</span><span class="o">=</span><span class="s">'name'</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">'outer'</span><span class="p">).</span><span class="n">drop</span><span class="p">(</span><span class="s">'name'</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#此处的pandas数据合并值得铭记，这里不加how声明，将会漏掉我国台湾省地区
</span><span class="n">pro</span><span class="p">.</span><span class="n">head</span><span class="p">()</span> 
<span class="nb">type</span><span class="p">(</span><span class="n">pro</span><span class="p">)</span> <span class="c1">#这里的pro依然还是geopandas数据，尽管经历了pandas的处理，这也说明二者的同源性
</span></code></pre></div></div>
<p>这里我们跳过列名重命名过程，直到这里，我们就可以绘制一个反应各地区电厂数量差异的地图了。</p>

<p><img src="/assets/pro_with_plants_counts.jpg" alt="各省份电厂数量" /></p>

<p>这是我第一篇学习笔记，写了大概一小时，接下来会记录python多进程运行的笔记</p>]]></content><author><name>Chen Huang</name></author><category term="python" /><category term="GIS" /><category term="Geopandas" /><category term="可视化" /><summary type="html"><![CDATA[最近学习了Geopandas的一些基本理念和操作。此文章是为我的学习记录。Geopandas起源于Pandas，也同时整合了许多其他依赖包的功能。目前来看，Geopandas的功能能够初步满足我对数据分析的地理化呈现的基本要求。]]></summary></entry></feed>